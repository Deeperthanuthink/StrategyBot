name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint bandit safety
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run Black (Code Formatter Check)
      run: |
        black --check --diff .
      continue-on-error: false
    
    - name: Run Flake8 (Linting)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Run Pylint (Static Analysis)
      run: |
        pylint src/ --exit-zero --disable=C0111,C0103,R0913,R0914,R0915,W0703
      continue-on-error: true

  security:
    name: Security Scans
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run Bandit (Security Linter)
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -ll
      continue-on-error: true
    
    - name: Run Safety (Dependency Security Check)
      run: |
        safety check --json || true
        safety check
      continue-on-error: true
    
    - name: Upload Bandit Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run Tests
      run: |
        if [ -d "tests" ]; then
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term
        else
          echo "No tests directory found, skipping tests"
        fi
      continue-on-error: true

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [code-quality, security, tests]
    if: always()
    
    steps:
    - name: Check if all jobs passed
      run: |
        if [ "${{ needs.code-quality.result }}" != "success" ]; then
          echo "❌ Code quality checks failed"
          exit 1
        fi
        if [ "${{ needs.security.result }}" != "success" ]; then
          echo "⚠️ Security scans had issues (non-blocking)"
        fi
        if [ "${{ needs.tests.result }}" != "success" ]; then
          echo "⚠️ Tests had issues (non-blocking)"
        fi
        echo "✅ All critical checks passed!"
